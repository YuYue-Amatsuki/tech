<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğ™¿ğš›ğš˜ğš“ğšğšŒğš ğ™µğš›ğšŠğšğš›ğšŠğš—ğšŒğš - è°±é¢ä¿¡æ¯æŸ¥çœ‹</title>
  <link rel="icon" href="logos/logo.png" type="image/x-icon">
  <style>
    @font-face {
        font-family: 'FZLanTYK_Zhun';
        src: url('fonts/FZLanTYK_Zhun.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    } 

    @font-face {
        font-family: 'FZLanTYK_Cu';
        src: url('fonts/FZLanTYK_Cu.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
    } 

    @font-face {
        font-family: 'MARUGOTHICDB';
        src: url('fonts/SEGA_MARUGOTHICDB.woff2') format('woff2');
        font-weight: 600;
        font-style: normal;
        font-display: swap;
    }

    body {
        font-family: 'FZLanTYK_Cu', 'FZLanTYK_Zhun';
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: url("img/prism-plus@2x.jpg") no-repeat center center fixed;
        -webkit-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
    }

    .container {
        background-color: #f5f5f542;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .search-box {
        display: flex;
        flex-direction: column; /* æ”¹ä¸ºå‚ç›´å¸ƒå±€ */
        gap: 10px; /* å¢åŠ é—´è· */
        margin-bottom: 20px;
    }

    input[type="text"], button {
        padding: 8px;
        margin: 5px;
        border: 1px solid #dddddd00;
        border-radius: 4px;
        box-sizing: border-box;
        width: 100%;
        background-color: #ffffff7e;
        font-family: 'MARUGOTHICDB', 'FZLanTYK_Zhun', 'FZLanTYK_Cu';
    }

    .search-box input[type="text"] {
        height: 40px; /* å¢åŠ é«˜åº¦ */
        font-size: 16px; /* å¢åŠ å­—ä½“å¤§å° */
        padding: 0 10px; /* å¢åŠ å·¦å³å†…è¾¹è· */
    }

    .search-box button {
        height: 40px; /* å¢åŠ é«˜åº¦ */
        font-size: 16px; /* å¢åŠ å­—ä½“å¤§å° */
        padding: 0 10px; /* å¢åŠ å·¦å³å†…è¾¹è· */
    }

    button {
        background-color: #ff699d;
        border: 3px solid white;
        color: white;
        cursor: pointer;
        font-family: 'FZLanTYK_Cu', 'FZLanTYK_Zhun';
    }

    button:hover {
        background-color: #e6457d;
    }

    .search-results,
    .song-details {
        background-color: #f5f5f542;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        font-family: 'MARUGOTHICDB', 'FZLanTYK_Zhun', 'FZLanTYK_Cu';
    }

    .song-details {
        display: none;
    }

    .result-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }

    .cover-sm {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-info div {
        margin: 3px 0;
    }

    .song-header {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 20px;
        padding: 20px;
    }

    .cover-img {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .song-info {
        flex: 1;
        text-align: left;
    }

    .song-info h3 {
        margin: 0 0 15px 0;
        font-size: 1.5em;
    }

    .song-info p {
        margin: 8px 0;
        line-height: 1.5;
    }

    .difficulties-container {
        width: 100%;
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }

    .difficulty-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .difficulty-info {
        margin-bottom: 15px;
        line-height: 1.6;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: white;
        border: 1px solid #dee2e6;
    }

    th {
        background: #f1f3f5;
        padding: 10px;
        border: 1px solid #dee2e6;
    }

    td {
        padding: 8px;
        text-align: center;
        border: 1px solid #dee2e6;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .back-button {
        display: inline-block;
        padding: 8px 16px;
        background-color: #ff699d;
        border: 3px solid white;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
    }

    .back-button:hover {
        background-color: #e6457d;
    }

    .audio-preview {
        margin: 15px 0;
        text-align: center;
    }

    .audio-preview audio {
        width: 100%;
        max-width: 500px;
        border-radius: 8px;
        font-family: 'MARUGOTHICDB', 'FZLanTYK_Zhun', 'FZLanTYK_Cu';
    }

    /* éš¾åº¦èƒŒæ™¯è‰² */
    .difficulty-section.basic {
        background: rgba(34, 187, 91, 0.95);
        border: 2px solid rgba(14, 117, 54, 0.95);
        color: white;
    }

    .difficulty-section.advanced {
        background: rgba(251, 156, 45, 0.95);
        border: 2px solid rgba(213, 117, 12, 0.95);
        color: white;
    }

    .difficulty-section.expert {
        background: rgba(246, 72, 97, 0.95);
        border: 2px solid rgba(188, 38, 52, 0.95);
        color: white;
    }

    .difficulty-section.master {
        background: rgba(158, 69, 226, 0.95);
        border: 2px solid rgba(111, 24, 173, 0.95);
        color: white;
    }

    .difficulty-section.remaster {
        background: rgba(186, 103, 248, 0.95);
        border: 2px solid rgba(192, 69, 227, 0.95);
        color: white;
    }

    /* è°ƒæ•´è¡¨æ ¼æ ·å¼ä»¥é€‚åº”æ·±è‰²èƒŒæ™¯ */
    .difficulty-section.basic table,
    .difficulty-section.advanced table,
    .difficulty-section.expert table,
    .difficulty-section.master table,
    .difficulty-section.remaster table {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
    }

    .footer-img {
        max-width: 100%;
        height: auto;
    }

    /* å“åº”å¼å¸ƒå±€ */
    @media screen and (max-width: 768px) {
        body {
            padding: 10px;
        }

        .container {
            padding: 15px;
        }

        .song-header {
            flex-direction: column; /* æ”¹ä¸ºå‚ç›´å¸ƒå±€ */
            align-items: center; /* å±…ä¸­å¯¹é½ */
        }

        .cover-img {
            width: 150px; /* ç¼©å°å°é¢å›¾ç‰‡ */
            height: 150px;
        }

        .song-info {
            text-align: center; /* å±…ä¸­å¯¹é½æ–‡å­— */
        }

        .difficulty-section {
            padding: 15px; /* ç¼©å°å†…è¾¹è· */
        }

        table {
            font-size: 14px; /* ç¼©å°è¡¨æ ¼å­—ä½“ */
        }

        th, td {
            padding: 6px; /* ç¼©å°å•å…ƒæ ¼å†…è¾¹è· */
        }

        .audio-preview audio {
            width: 100%; /* éŸ³é¢‘æ’­æ”¾å™¨å®½åº¦é€‚é… */
        }

        .back-button {
            width: 100%; /* æŒ‰é’®å®½åº¦é€‚é… */
            text-align: center;
        }

        .footer-img {
            width: 100%; /* åº•éƒ¨å›¾ç‰‡å®½åº¦é€‚é… */
            height: auto;
        }

        .difficulties-container {
            overflow-x: auto;
        }

        .difficulty-section table {
            min-width: 400px; /* ä¿è¯è¡¨æ ¼ä¸ä¼šå¤ªçª„ */
            font-size: 13px;
        }

        table {
            display: block;
            width: 100%;
            overflow-x: auto;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="logos/logo3.png" alt="Logo" class="logo" width="100" height="100">
    <h2>è°±é¢ä¿¡æ¯æŸ¥çœ‹</h2>
    <div class="search-box">
      <input type="text" id="keyword" placeholder="è¯·è¾“å…¥æ›²ç›®å…³é”®è¯æˆ–åˆ«å">
      <button onclick="handleSearch()">æœç´¢</button>
    </div>
    <div class="search-results" id="searchResults"></div>
    <div class="song-details" id="songDetails"></div>
    <p style="text-align:center">Presented by YuYue-Amatsuki</p>
  </div>

  <script>
    let beatmapData = {};
    let musicDetails = [];

    function padId(id) {
      return String(id).padStart(5, '0');
    }

    (async function init() {
      try {
        showLoading("æ­£åœ¨åŠ è½½æ›²ç›®æ•°æ®...");
        const response = await fetch('https://api.milkbot.cn/server/api/getdata');
        const rawData = await response.json();
        beatmapData = Object.fromEntries(
            Object.entries(rawData).map(([k, v]) => [String(k), v])
        );

        const detailResponse = await fetch('https://www.diving-fish.com/api/maimaidxprober/music_data');
        musicDetails = await detailResponse.json();

        hideLoading(); // åŠ è½½å®Œæˆåéšè—å®¹å™¨
      } catch (error) {
        showError("æ›²ç›®æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
      }
    })();

    function showLoading(text) {
        const searchResults = document.getElementById('searchResults');
        const songDetails = document.getElementById('songDetails');
        
        // æ˜¾ç¤ºæœç´¢ç»“æœå®¹å™¨å’ŒåŠ è½½æç¤ºæ¡†
        searchResults.style.display = 'block';
        songDetails.style.display = 'none';
        searchResults.innerHTML = `<div class="loading">${text}</div>`;
    }

    function showError(msg) {
        const searchResults = document.getElementById('searchResults');
        const songDetails = document.getElementById('songDetails');
        
        // ç¡®ä¿æœç´¢ç»“æœå®¹å™¨å¯è§
        searchResults.style.display = 'block';
        songDetails.style.display = 'none';
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        searchResults.innerHTML = `
            <div class="result-item" style="color: #dc3545;">${msg}</div>
        `;
    }

    function hideLoading() {
        const searchResults = document.getElementById('searchResults');
        const loadingElement = document.querySelector('.loading');
        
        // ç§»é™¤åŠ è½½æç¤ºæ¡†
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // åˆå§‹åŠ è½½å®Œæˆæ—¶éšè—æœç´¢ç»“æœå®¹å™¨
        if (!document.getElementById('keyword').value.trim()) {
            searchResults.style.display = 'none';
        }
    }

    async function handleSearch() {
      const keyword = document.getElementById('keyword').value.trim();
      if (!keyword) return alert("è¯·è¾“å…¥æœç´¢å…³é”®è¯");

      try {
        showLoading("æœç´¢ä¸­...");
        fetch('https://api.milkbot.cn/server/api/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ search: keyword })
        })
        .then(response => response.json())
        .then(data => {
            console.log('æœç´¢è¿”å›æ•°æ®:', data);

            if (!data || data.returnCode !== 1) {
                return renderResults([]);
            }

            const results = (data.ID || []).map(id => ({
                id: String(id),
                name: beatmapData[String(id)] || "æœªçŸ¥æ›²ç›®"
            }));

            renderResults(results);
        })
        .catch(error => {
            console.error('æœç´¢é”™è¯¯:', error);
            showError("æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
        })
        .finally(() => {
            hideLoading();
        });
      } catch (error) {
        showError("æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
        hideLoading();
      }
    }

    function renderResults(results) {
      const searchResults = document.getElementById('searchResults');
      const songDetails = document.getElementById('songDetails');
      
      searchResults.style.display = 'block';
      songDetails.style.display = 'none';
      
      if (!results || !results.length) {
          searchResults.innerHTML = '<div class="result-item">æœªæ‰¾åˆ°ç›¸å…³è°±é¢</div>';
          return;
      }

      const resultHTML = results.map(item => {
          const paddedId = padId(item.id);
          const coverUrl = `https://www.diving-fish.com/covers/${paddedId}.png`;
          return `
              <div class="result-item" onclick="handleSelect('${item.name.replace(/'/g, "\\'")}', '${item.id}')">
                  <img src="${coverUrl}" class="cover-sm" onerror="this.style.display='none'">
                  <div class="search-result-info">
                      <div>[ID: ${item.id}]</div>
                      <div><strong>${item.name}</strong></div>
                  </div>
              </div>
          `;
      }).join('');

      searchResults.innerHTML = resultHTML;
    }

    function handleSelect(songName, songId) {
      const searchResults = document.getElementById('searchResults');
      const songDetails = document.getElementById('songDetails');
      const paddedId = padId(songId);
      const coverUrl = `https://www.diving-fish.com/covers/${paddedId}.png`;
      const matched = musicDetails.filter(m => m.title === songName);

      // éšè—æœç´¢ç»“æœï¼Œæ˜¾ç¤ºè¯¦æƒ…
      searchResults.style.display = 'none';
      songDetails.style.display = 'block';

      let content = `
        <button class="back-button" onclick="showSearchResults()">è¿”å›æœç´¢ç»“æœ</button>
        <div class="song-header">
          <img src="${coverUrl}" class="cover-img" onerror="this.style.display='none'">
          <div class="song-info">
            <h3>${songName}</h3>
            <p><strong>ID:</strong> ${songId}</p>
      `;

      if (matched.length === 0) {
        content += `<p>æœªæ‰¾åˆ°è¯¦ç»†ä¿¡æ¯</p></div></div>`;
        songDetails.innerHTML = content;
        return;
      }

      const song = matched[0];
      
      // å¤„ç†éŸ³é¢‘é¢„è§ˆçš„ ID
      let audioId = parseInt(songId);
      if (audioId > 10000 && !songId.startsWith('10')) {
          // å¦‚æœ ID å¤§äº 10000 ä¸”ä¸æ˜¯å®´ä¼šåœºæ›²ç›®ï¼Œå»é™¤ç¬¬ä¸€ä½æ•°å­—
          audioId = parseInt(songId.substring(1));
      }
      const audioUrl = `https://assets2.lxns.net/maimai/music/${audioId}.mp3`;
      
      content += `
                <p><strong>æ›²å¸ˆ:</strong> ${song.basic_info.artist}</p>
                <p><strong>æµæ´¾:</strong> ${song.basic_info.genre}</p>
                <p><strong>BPM:</strong> ${song.basic_info.bpm}</p>
                <p><strong>ç‰ˆæœ¬:</strong> ${song.basic_info.from}</p>
            </div>
        </div>
        <div class="audio-preview">
            <audio controls preload="none">
                <source src="${audioUrl}" type="audio/mpeg">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
            </audio>
        </div>
        <div class="difficulties-container">
    `;

    const difficulties = song.level.map((lvl, i) => {
        const chart = song.charts[i];
        const notes = chart?.notes || [];
        const noteLabels = song.type === 'DX'
            ? ['Tap', 'Hold', 'Slide', 'Touch', 'Break']
            : ['Tap', 'Hold', 'Slide', 'Break'];

        const difficultyNames = ['BASIC', 'ADVANCED', 'EXPERT', 'MASTER', 'Re:MASTER'];
        const difficultyName = difficultyNames[i] || 'æœªçŸ¥éš¾åº¦';
        
        // æ·»åŠ éš¾åº¦å¯¹åº”çš„ CSS ç±»å
        const difficultyClass = difficultyName.toLowerCase().replace(':', '');

        const fullNotes = [...notes];
        while (fullNotes.length < noteLabels.length) fullNotes.push(0);
        const total = fullNotes.reduce((sum, n) => sum + (n || 0), 0);

        const headers = noteLabels.map(label => `<th>${label}</th>`).join('') + `<th>Total</th>`;
        const values = fullNotes.map(n => `<td>${n}</td>`).join('') + `<td><strong>${total}</strong></td>`;

        return `
            <div class="difficulty-section ${difficultyClass}">
                <div class="difficulty-info">
                    <p><strong>éš¾åº¦:</strong> ${difficultyName} ${lvl} (${song.type})</p>
                    <p><strong>å®šæ•°:</strong> ${song.ds[i]}</p>
                    <p><strong>è°±å¸ˆ:</strong> ${chart?.charter || 'æœªçŸ¥'}</p>
                </div>
                <table>
                    <thead><tr>${headers}</tr></thead>
                    <tbody><tr>${values}</tr></tbody>
                </table>
            </div>
        `;
    }).join('');

    content += difficulties + '</div>';
    songDetails.innerHTML = content;
    }

    function showSearchResults() {
      document.getElementById('searchResults').style.display = 'block';
      document.getElementById('songDetails').style.display = 'none';
    }
  </script>
  <footer style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
         <img src="img/UI_CMN_TrackStart_MugenMap.png" class="footer-img">
     </footer>
</body>
</html>